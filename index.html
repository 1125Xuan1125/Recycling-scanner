<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recycling Scanner</title>
    <!-- React Â∫ì -->
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Babel Áî®‰∫éËß£Êûê JSX -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase v10.12.4 -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
      import { 
        getAuth, 
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut,
        sendEmailVerification // *** ÊÅ¢Â§çÔºöÂèëÈÄÅÈ™åËØÅÈÇÆ‰ª∂ ***
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
      import { 
        getFirestore, 
        doc, 
        setDoc, 
        getDoc, 
        collection, 
        onSnapshot, 
        query,
        updateDoc,
        increment,
        where,
        getDocs,
        addDoc
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

      try {
        const firebaseConfig = {
          apiKey: "AIzaSyDDtDFM7Xa5LTk0pZ13sd__9j_HvmV9K4o",
          authDomain: "recycling-scanner-web.firebaseapp.com",
          projectId: "recycling-scanner-web",
          storageBucket: "recycling-scanner-web.firebasestorage.app",
          messagingSenderId: "470256374118",
          appId: "1:470256374118:web:3a705fdaf4b6c6f66cf8a7"
        };

        const app = initializeApp(firebaseConfig);
        
        window.firebase = {
          app,
          auth: getAuth(app),
          db: getFirestore(app),
          onAuthStateChanged,
          createUserWithEmailAndPassword,
          signInWithEmailAndPassword,
          signOut,
          sendEmailVerification, // *** ÂØºÂá∫ ***
          doc,
          setDoc,
          getDoc,
          collection,
          onSnapshot,
          query,
          updateDoc,
          increment,
          where,
          getDocs,
          addDoc
        };
        
        console.log("Firebase module script loaded and initialized.");

      } catch (error) {
        console.error("CRITICAL FIREBASE MODULE ERROR:", error);
        window.firebaseError = error.message; 
      }
    </script>
    
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Gemini API Configuration
        const GEMINI_API_KEY = 'AIzaSyD4tQu-bNUIcwg0xjY01vQgNa7fR5AM1zU'; 
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent';

        // --- Icon components ---
        const Camera = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );
        const Upload = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
        );
        const Menu = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" />
            </svg>
        );
        const X = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );
        const Home = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        );
        const Info = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        const MessageSquare = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
        );
        const Trophy = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6m12 5h1.5a2.5 2.5 0 0 0 0-5H18m-12 0h12v6a6 6 0 0 1-12 0V4Zm6 11v5m-3 0h6" />
            </svg>
        );
        const Trash2 = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );
        const LogOut = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
            </svg>
        );
        const UserCircle = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        const TrashIcon = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );
        const Spinner = ({ className }) => (
            <svg className={`animate-spin ${className}`} xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );
        const Crown = ({ className }) => (
             <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
        );
        // --- End Icon Components ---

        const recyclingInfo = [
            {
                colorName: 'Blue',
                colorClass: 'bg-blue-500',
                title: 'Paper',
                description: 'Newspapers, magazines, cardboard boxes, office paper, etc.',
                tip: 'Paper should be kept dry and flattened.'
            },
            {
                colorName: 'Brown',
                colorClass: 'bg-[#8B4513]', 
                title: 'Glass',
                description: 'Glass bottles, glass containers, etc.',
                tip: 'Rinse clean and handle with care.'
            },
            {
                colorName: 'Orange',
                colorClass: 'bg-orange-500',
                title: 'Plastic & Others',
                description: 'Plastic bottles, plastic containers, cans, metal, aluminum products, etc.',
                tip: 'Plastics and metals need to be washed and flattened.'
            },
            {
                colorName: 'Black / Dark Green',
                colorClass: 'bg-gray-800', 
                title: 'General Waste',
                description: 'Kitchen waste, contaminated tissues, diapers, dust, and other non-recyclable waste.',
                tip: 'This is the main daily waste.'
            },
            {
                colorName: 'Red',
                colorClass: 'bg-red-600',
                title: 'Hazardous Waste',
                description: 'Used batteries, light bulbs/tubes, expired medicines, etc.',
                tip: 'Store separately and safely; send to designated collection points.'
            }
        ];
        
        const LoadingPage = () => (
            <div className="min-h-screen bg-gray-100 flex items-center justify-center">
                <div className="text-center">
                    <Spinner className="h-10 w-10 text-green-600 mx-auto mb-4" />
                    <p className="text-lg text-gray-700">Loading...</p>
                </div>
            </div>
        );

        const CriticalErrorPage = ({ message }) => (
            <div className="min-h-screen bg-red-100 flex items-center justify-center p-6">
                <div className="bg-white rounded-lg shadow-xl p-8 max-w-lg w-full">
                    <h2 className="text-2xl font-bold text-red-700 mb-4">A Critical Error Occurred</h2>
                    <p className="text-gray-700 mb-2">The application could not start. This is often due to a Firebase configuration issue or a network problem.</p>
                    <div className="bg-gray-100 p-4 rounded text-red-800 font-mono text-sm overflow-x-auto">
                        <strong>Error:</strong> {message || "Unknown Error"}
                    </div>
                </div>
            </div>
        );

        const WelcomePage = ({ setCurrentPage }) => (
            <div className="min-h-screen bg-gradient-to-br from-green-400 via-emerald-500 to-teal-600 flex items-center justify-center p-6">
                <div className="text-center">
                    <div className="mb-8 flex justify-center">
                        <div className="bg-white rounded-full p-8 shadow-2xl">
                            <Trash2 className="w-24 h-24 text-green-600" />
                        </div>
                    </div>
                    <h1 className="text-5xl font-bold text-white mb-4">Welcome to</h1>
                    <h2 className="text-6xl font-extrabold text-white mb-8">Recycling Scanner</h2>
                    <p className="text-xl text-white mb-12 max-w-md mx-auto">
                        Scan items, learn about recycling, and compete on the leaderboard!
                    </p>
                    <button
                        onClick={() => setCurrentPage('login')}
                        className="bg-white text-green-600 px-12 py-4 rounded-full text-xl font-bold hover:bg-green-50 transform hover:scale-105 transition shadow-lg"
                    >
                        Start Scanning
                    </button>
                </div>
            </div>
        );
        
        const LoginPage = ({ 
            handleAuthAction, 
            email, setEmail, 
            password, setPassword, 
            username, setUsername, 
            isLoginView, setIsLoginView, 
            authError,
            signupSuccess,
            isAuthActionLoading 
        }) => (
            <div className="min-h-screen bg-gradient-to-br from-green-400 via-emerald-500 to-teal-600 flex items-center justify-center p-6">
                <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
                    <h2 className="text-3xl font-bold text-center text-gray-800 mb-4">
                        {isLoginView ? 'Login' : 'Sign Up'}
                    </h2>
                    <p className="text-center text-gray-500 mb-6">
                        {isLoginView ? 'Welcome back!' : 'Create your account'}
                    </p>
                    
                    <form onSubmit={handleAuthAction} className="space-y-4">
                        {!isLoginView && (
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
                                <input 
                                    type="text" 
                                    value={username}
                                    onChange={(e) => setUsername(e.target.value)}
                                    required
                                    className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                                />
                            </div>
                        )}
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
                            <input 
                                type="email" 
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                required
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input 
                                type="password" 
                                value={password}
                                onChange={(e) => setPassword(e.target.value)}
                                required
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500"
                            />
                        </div>
                        
                        {signupSuccess && (
                            <div className="p-3 bg-green-100 border border-green-300 text-green-700 rounded text-sm text-center">
                                <p className="font-bold">Sign up successful!</p>
                                <p>Verification email sent. <strong>Please check your Inbox and Spam folder</strong>.</p>
                            </div>
                        )}
                        {authError && (
                            <p className="text-sm text-red-600 text-center">{authError}</p>
                        )}

                        <button 
                            type="submit"
                            disabled={isAuthActionLoading} 
                            className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition flex items-center justify-center disabled:bg-gray-400"
                        >
                            {isAuthActionLoading ? (
                                <Spinner className="h-5 w-5 text-white" />
                            ) : (
                                isLoginView ? 'Login' : 'Sign Up'
                            )}
                        </button>
                    </form>
                    
                    <button 
                        onClick={() => {
                            setIsLoginView(!isLoginView);
                            setAuthError(''); 
                            setSignupSuccess(false); 
                        }}
                        className="w-full mt-4 text-sm text-green-600 hover:underline"
                    >
                        {isLoginView ? 'No account? Sign Up' : 'Already have an account? Login'}
                    </button>
                </div>
            </div>
        );

        const ProfileModal = ({ 
            user, 
            userProfile, 
            handleLogout, 
            setProfileOpen,
            activationCode,
            setActivationCode,
            handleActivatePremium,
            activationStatus,
            isActivating,
            handleResendVerification, // *** Êñ∞Â¢û ***
            resendStatus // *** Êñ∞Â¢û ***
        }) => {
            // Admin Tools (State moved inside here for simplicity in this file)
            const [genCount, setGenCount] = useState(10);
            const [generatedCodes, setGeneratedCodes] = useState([]);
            const [isGenerating, setIsGenerating] = useState(false);
            
            const handleBatchGenerate = async () => {
                if (!window.firebase) return;
                setIsGenerating(true);
                const codes = [];
                const batchPromises = [];
                try {
                    for (let i = 0; i < genCount; i++) {
                        const randomPart = Math.random().toString(36).substring(2, 6).toUpperCase() + '-' + Math.random().toString(36).substring(2, 6).toUpperCase();
                        const code = `VIP-${randomPart}`;
                        codes.push(code);
                        batchPromises.push(
                            window.firebase.addDoc(window.firebase.collection(window.firebase.db, 'activation_codes'), {
                                code: code,
                                isUsed: false,
                                type: 'lifetime',
                                createdAt: new Date()
                            })
                        );
                    }
                    await Promise.all(batchPromises);
                    setGeneratedCodes(codes);
                } catch (error) {
                    console.error("Batch generation failed:", error);
                    alert("Failed to generate codes: " + error.message);
                } finally {
                    setIsGenerating(false);
                }
            };

            return (
                <div 
                    className="fixed inset-0 bg-black bg-opacity-50 z-40 flex items-center justify-center p-4"
                    onClick={() => setProfileOpen(false)} 
                >
                    <div 
                        className="bg-white rounded-2xl shadow-2xl p-6 max-w-sm w-full relative max-h-[90vh] overflow-y-auto"
                        onClick={(e) => e.stopPropagation()} 
                    >
                        <button 
                            onClick={() => setProfileOpen(false)}
                            className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"
                        >
                            <X className="w-6 h-6" />
                        </button>
                        
                        <div className="flex flex-col items-center">
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">Profile</h2>
                            
                            <div
                                className="w-24 h-24 rounded-full bg-green-100 flex items-center justify-center mb-4 relative"
                            >
                                {userProfile?.isPremium ? (
                                    <div className="relative">
                                        <div className="absolute -top-2 -right-2 bg-yellow-400 rounded-full p-1">
                                            <Crown className="w-6 h-6 text-white" />
                                        </div>
                                        <UserCircle className="w-20 h-20 text-yellow-600" />
                                    </div>
                                ) : (
                                    <UserCircle className="w-20 h-20 text-green-600" />
                                )}
                            </div>
                            
                            <p className="text-lg font-medium text-gray-700 break-all text-center">
                                {user?.email}
                            </p>
                            
                            {/* *** ÈÇÆÁÆ±È™åËØÅÁä∂ÊÄÅ *** */}
                            <div className="flex items-center gap-2 mb-1">
                                <span className={`text-xs px-2 py-0.5 rounded border ${user?.emailVerified ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-700 border-red-200'}`}>
                                    {user?.emailVerified ? 'Verified' : 'Unverified'}
                                </span>
                                {!user?.emailVerified && (
                                    <button 
                                        onClick={handleResendVerification} 
                                        className="text-xs text-blue-600 underline hover:text-blue-800"
                                    >
                                        Resend Email
                                    </button>
                                )}
                            </div>
                            {resendStatus && <p className="text-xs text-green-600 mb-2">{resendStatus}</p>}

                            <p className="text-sm text-gray-500 mb-2">
                                Username: {userProfile?.username ? userProfile.username : (user?.email ? user.email.split('@')[0] : '...')}
                            </p>
                            
                            <div className={`px-4 py-1 rounded-full text-sm font-bold mb-6 ${userProfile?.isPremium ? 'bg-yellow-100 text-yellow-700' : 'bg-gray-100 text-gray-600'}`}>
                                {userProfile?.isPremium ? 'üëë Premium Member' : 'Standard Member'}
                            </div>
                            
                            {/* ÊøÄÊ¥ªÁ†ÅËæìÂÖ• */}
                            {!userProfile?.isPremium && (
                                <div className="w-full mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                    <h3 className="text-sm font-semibold text-gray-700 mb-2">Activate Premium</h3>
                                    <div className="flex gap-2 mb-2">
                                        <input 
                                            type="text" 
                                            value={activationCode}
                                            onChange={(e) => setActivationCode(e.target.value)}
                                            placeholder="Enter Code"
                                            className="flex-1 px-3 py-2 text-sm border rounded focus:outline-none focus:ring-1 focus:ring-green-500"
                                        />
                                        <button 
                                            onClick={handleActivatePremium}
                                            disabled={isActivating || !activationCode.trim()}
                                            className="bg-green-600 text-white px-3 py-2 rounded text-sm font-semibold hover:bg-green-700 disabled:bg-gray-400"
                                        >
                                            {isActivating ? '...' : 'Go'}
                                        </button>
                                    </div>
                                    {activationStatus && (
                                        <p className={`text-xs ${activationStatus.includes('Success') ? 'text-green-600' : 'text-red-600'}`}>
                                            {activationStatus}
                                        </p>
                                    )}
                                </div>
                            )}

                            {/* *** ÂÆâÂÖ®ÁöÑÁÆ°ÁêÜÂëòÂ∑•ÂÖ∑: ÂøÖÈ°ªÈ™åËØÅÈÇÆÁÆ± *** */}
                            {user?.email === 'kahxuan1125@gmail.com' && user?.emailVerified && (
                                <div className="w-full mb-6 pt-4 border-t border-gray-200">
                                    <h3 className="text-sm font-bold text-gray-800 mb-3">Admin: Generate Codes</h3>
                                    <div className="flex gap-2 mb-3">
                                        <input
                                            type="number"
                                            value={genCount}
                                            onChange={(e) => setGenCount(Number(e.target.value))}
                                            className="w-20 px-3 py-2 text-sm border rounded"
                                            min="1"
                                            max="50"
                                        />
                                        <button
                                            onClick={handleBatchGenerate}
                                            disabled={isGenerating}
                                            className="flex-1 bg-blue-600 text-white px-3 py-2 rounded text-sm font-semibold hover:bg-blue-700 disabled:bg-gray-400"
                                        >
                                            {isGenerating ? 'Generating...' : 'Generate'}
                                        </button>
                                    </div>
                                    {generatedCodes.length > 0 && (
                                        <div className="bg-gray-100 p-2 rounded text-xs font-mono max-h-32 overflow-y-auto select-all border border-gray-300">
                                            <p className="text-gray-500 mb-1">Copy these codes:</p>
                                            {generatedCodes.map((code, i) => (
                                                <div key={i} className="mb-1">{code}</div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}

                            <button
                                onClick={handleLogout}
                                className="w-full bg-red-600 text-white py-3 rounded-lg font-semibold hover:bg-red-700 transition flex items-center justify-center gap-2"
                            >
                                <LogOut className="w-5 h-5" />
                                <span>Logout</span>
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const HomePage = ({
            setMenuOpen, menuOpen, handleLogout, setCurrentPage, setProfileOpen,
            leaderboard, uploadInputRef, cameraInputRef, handleImageUpload,
            scannedImage, scanResult,
            handleAddScore,
            scoreAdded,
            userProfile,
            user,
            currentUserEntry 
        }) => (
            <div className="min-h-screen bg-gray-50">
                <header className="bg-green-600 text-white p-4 shadow-lg">
                    <div className="flex items-center justify-between">
                        <button onClick={() => setMenuOpen(!menuOpen)} className="p-2 hover:bg-green-700 rounded-lg">
                            {menuOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
                        </button>
                        <h1 className="text-2xl font-bold">Recycling Scanner</h1>
                        <button 
                            onClick={() => setProfileOpen(true)}
                            className="p-2 hover:bg-green-700 rounded-full"
                        >
                            <UserCircle className="w-7 h-7" />
                        </button>
                    </div>
                </header>

                {menuOpen && (
                    <div className="bg-white shadow-lg border-b">
                        <button
                            onClick={() => { setCurrentPage('home'); setMenuOpen(false); }}
                            className="w-full px-6 py-4 flex items-center gap-3 hover:bg-gray-100 border-b"
                        >
                            <Home className="w-5 h-5 text-green-600" />
                            <span className="font-medium">Home</span>
                        </button>
                        <button
                            onClick={() => { setCurrentPage('information'); setMenuOpen(false); }}
                            className="w-full px-6 py-4 flex items-center gap-3 hover:bg-gray-100 border-b"
                        >
                            <Info className="w-5 h-5 text-green-600" />
                            <span className="font-medium">Information</span>
                        </button>
                        <button
                            onClick={() => { setCurrentPage('feedback'); setMenuOpen(false); }}
                            className="w-full px-6 py-4 flex items-center gap-3 hover:bg-gray-100 border-b"
                        >
                            <MessageSquare className="w-5 h-5 text-green-600" />
                            <span className="font-medium">Feedback</span>
                        </button>
                        <button
                            onClick={handleLogout}
                            className="w-full px-6 py-4 flex items-center gap-3 hover:bg-gray-100 text-red-600"
                        >
                            <LogOut className="w-5 h-5" />
                            <span className="font-medium">Logout</span>
                        </button>
                    </div>
                )}

                <div className="p-6 max-w-4xl mx-auto">
                    {/* ... (ÊéíË°åÊ¶ú) ... */}
                    <div className="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div className="flex items-center gap-3 mb-4">
                            <Trophy className="w-8 h-8 text-yellow-500" />
                            <h2 className="text-2xl font-bold text-gray-800">Leaderboard</h2>
                        </div>
                        <div className="space-y-3">
                            {leaderboard.length > 0 ? (
                                <>
                                    {leaderboard.map((entry, index) => {
                                        const isCurrentUser = user && entry.id === user.uid;
                                        return (
                                            <div key={entry.id || index} className={`flex items-center justify-between p-4 rounded-lg transition-all ${
                                                isCurrentUser 
                                                ? 'bg-green-50 border-2 border-green-500 shadow-md transform scale-[1.02] z-10' 
                                                : 'bg-white border border-gray-100 hover:bg-gray-50 hover:shadow-sm'
                                            }`}>
                                                <div className="flex items-center gap-4">
                                                    <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white shadow-sm ${
                                                        index === 0 ? 'bg-yellow-500' : index === 1 ? 'bg-gray-400' : index === 2 ? 'bg-orange-500' : 'bg-green-600'
                                                    }`}>
                                                        {index + 1}
                                                    </div>
                                                    <div>
                                                        <div className="flex items-center gap-2">
                                                            <p className="font-bold text-gray-800">{entry.name}</p>
                                                            {isCurrentUser && (
                                                                <span className="bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded-full border border-green-200 font-medium">
                                                                    You
                                                                </span>
                                                            )}
                                                        </div>
                                                        <p className="text-sm text-gray-500">{entry.items} items recycled</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-2xl font-bold text-green-600">{entry.score}</p>
                                                    <p className="text-xs text-gray-500">points</p>
                                                </div>
                                            </div>
                                        );
                                    })}
                                    
                                    {currentUserEntry && currentUserEntry.rank > 5 && (
                                        <>
                                            <div className="flex items-center justify-center py-2 opacity-50">
                                                <div className="w-1 h-1 bg-gray-400 rounded-full mx-1"></div>
                                                <div className="w-1 h-1 bg-gray-400 rounded-full mx-1"></div>
                                                <div className="w-1 h-1 bg-gray-400 rounded-full mx-1"></div>
                                            </div>
                                            <div className="flex items-center justify-between p-4 bg-green-50 border-2 border-green-500 rounded-lg shadow-md transform scale-[1.02] transition-all z-10">
                                                <div className="flex items-center gap-4">
                                                    <div className="w-10 h-10 rounded-full flex items-center justify-center font-bold text-white bg-green-600 shadow-sm">
                                                        {currentUserEntry.rank}
                                                    </div>
                                                    <div>
                                                        <div className="flex items-center gap-2">
                                                            <p className="font-bold text-gray-800">{currentUserEntry.name}</p>
                                                            <span className="bg-green-100 text-green-700 text-xs px-2 py-0.5 rounded-full border border-green-200 font-medium">
                                                                You
                                                            </span>
                                                        </div>
                                                        <p className="text-sm text-gray-500">{currentUserEntry.items} items recycled</p>
                                                    </div>
                                                </div>
                                                <div className="text-right">
                                                    <p className="text-2xl font-bold text-green-600">{currentUserEntry.score}</p>
                                                    <p className="text-xs text-gray-500">points</p>
                                                </div>
                                            </div>
                                        </>
                                    )}
                                </>
                            ) : (
                                <p className="text-gray-500 text-center py-4">Loading leaderboard or no data...</p>
                            )}
                        </div>
                    </div>
                    
                    {/* *** Êâ´ÊèèÊ¨°Êï∞ÊòæÁ§∫ *** */}
                    <div className="mb-4 flex justify-between items-center px-2">
                        <span className="font-semibold text-gray-700">Daily Usage:</span>
                        {userProfile?.isPremium ? (
                            <span className="flex items-center gap-1 text-yellow-600 font-bold">
                                <Crown className="w-5 h-5" /> Premium (Unlimited)
                            </span>
                        ) : (
                            <span className={`font-bold ${userProfile?.dailyScanCount >= 5 ? 'text-red-600' : 'text-green-600'}`}>
                                {userProfile?.dailyScanCount || 0}/5 Scans
                            </span>
                        )}
                    </div>

                    {/* ... (Êâ´ÊèèÊåâÈíÆ) ... */}
                    <div className="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-lg p-8 text-center">
                        <h3 className="text-2xl font-bold text-white mb-4">Scan Your Item</h3>
                        <p className="text-white mb-6">Take a photo or upload an image to identify recyclable items</p>
                        <div className="flex gap-4 justify-center flex-wrap">
                            <button
                                onClick={() => uploadInputRef.current?.click()}
                                className="bg-white text-green-600 px-6 py-3 rounded-lg font-semibold hover:bg-green-50 transition flex items-center gap-2"
                            >
                                <Upload className="w-5 h-5" />
                                Upload Image
                            </button>
                            <button
                                onClick={() => cameraInputRef.current?.click()}
                                className="bg-emerald-700 text-white px-6 py-3 rounded-lg font-semibold hover:bg-emerald-800 transition flex items-center gap-2"
                            >
                                <Camera className="w-5 h-5" />
                                Take Photo
                            </button>
                        </div>
                        <input
                            ref={uploadInputRef}
                            type="file"
                            accept="image/*"
                            onChange={handleImageUpload}
                            className="hidden"
                        />
                        <input
                            ref={cameraInputRef}
                            type="file"
                            accept="image/*"
                            capture="environment"
                            onChange={handleImageUpload}
                            className="hidden"
                        />
                    </div>
                    
                    {scannedImage && (
                        <div className="mt-6 bg-white rounded-xl shadow-lg p-6">
                            <h3 className="text-xl font-bold mb-4">Scan Result</h3>
                            <img src={scannedImage} alt="Scanned" className="w-full max-h-64 object-contain rounded-lg mb-4" />
                            {scanResult ? (
                                <> 
                                    <div className={`p-4 rounded-lg ${scanResult.recyclable ? 'bg-green-50 border-2 border-green-500' : 'bg-red-50 border-2 border-red-500'}`}>
                                        <p className="text-lg font-bold mb-2">{scanResult.type}</p>
                                        <p className="text-sm mb-1">Category: {scanResult.category}</p>
                                        <div className="mb-2">
                                            <div className="flex items-center gap-2">
                                                <span className="text-sm">Confidence: {scanResult.confidence}%</span>
                                                <div className="flex-1 bg-gray-200 rounded-full h-2 overflow-hidden">
                                                    <div 
                                                        className={`h-full rounded-full ${
                                                            scanResult.confidence >= 90 ? 'bg-green-500' :
                                                            scanResult.confidence >= 70 ? 'bg-yellow-500' :
                                                            'bg-orange-500'
                                                        }`}
                                                        style={{width: `${scanResult.confidence}%`}}
                                                    ></div>
                                                </div>
                                            </div>
                                            {scanResult.confidence < 70 && (
                                                <p className="text-xs text-orange-600 mt-1">‚ö†Ô∏è Low confidence - please verify manually</p>
                                            )}
                                        </div>
                                        <p className={`font-bold text-lg ${scanResult.recyclable ? 'text-green-600' : 'text-red-600'}`}>
                                            {scanResult.recyclable ? '‚ôªÔ∏è RECYCLABLE' : '‚ùå NOT RECYCLABLE'}
                                        </p>
                                    </div>
                                    
                                    <button
                                        onClick={handleAddScore}
                                        disabled={!scanResult.recyclable || scoreAdded}
                                        className={`w-full mt-4 py-3 rounded-lg font-semibold text-white transition ${
                                            (!scanResult.recyclable || scoreAdded)
                                                ? 'bg-gray-400 cursor-not-allowed'
                                                : 'bg-green-600 hover:bg-green-700'
                                        }`}
                                    >
                                        {scoreAdded ? '‚úì Added!' : 'Recycle! (+10 Points)'}
                                    </button>
                                </>
                            ) : (
                                <div className="text-center py-8">
                                    <Spinner className="h-8 w-8 text-green-600 mx-auto" />
                                    <p className="mt-3 text-gray-500">Analyzing image...</p>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            </div>
        );

        // --- InformationPage and FeedbackPage (No changes to limit logic) ---
        const InformationPage = ({
            setMenuOpen, menuOpen, handleLogout, setCurrentPage, setProfileOpen,
            recyclingInfo
        }) => (
            <div className="min-h-screen bg-gray-50">
                <header className="bg-green-600 text-white p-4 shadow-lg">
                    <div className="flex items-center justify-between">
                        <button onClick={() => setMenuOpen(!menuOpen)} className="p-2 hover:bg-green-700 rounded-lg">
                            {menuOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
                        </button>
                        <h1 className="text-2xl font-bold">Recycling Information</h1>
                        <button 
                            onClick={() => setProfileOpen(true)}
                            className="p-2 hover:bg-green-700 rounded-full"
                        >
                            <UserCircle className="w-7 h-7" />
                        </button>
                    </div>
                </header>
                {menuOpen && (
                    <div className="bg-white shadow-lg border-b">
                        <button
                            onClick={() => { setCurrentPage('home'); setMenuOpen(false); }}
                            className="w-full px-6 py-4 flex items-center gap-3 hover:bg-gray-100 border-b"
                        >
                            <Home className="w-5 h-5 text-green-600" />
                            <span className="font-medium">Home</span>
                        </button>
                        <button
                            onClick={() => { setCurrentPage('information'); setMenuOpen(false); }}
                            className="w-full px-6 py-4 flex items-center gap-3 hover:bg-gray-100 border-b"
                        >
                            <Info className="w-5 h-5 text-green-600" />
                            <span className="font-medium">Information</span>
                        </button>
                        <button
                            onClick={() => { setCurrentPage('feedback'); setMenuOpen(false); }}
                            className="w-full px-6 py-4 flex items-center gap-3 hover:bg-gray-100 border-b"
                        >
                            <MessageSquare className="w-5 h-5 text-green-600" />
                            <span className="font-medium">Feedback</span>
                        </button>
                        <button
                            onClick={handleLogout}
                            className="w-full px-6 py-4 flex items-center gap-3 hover:bg-gray-100 text-red-600"
                        >
                            <LogOut className="w-5 h-5" />
                            <span className="font-medium">Logout</span>
                        </button>
                    </div>
                )}
                
                <div className="p-6 max-w-4xl mx-auto">
                    <div className="mb-8 text-center">
                        <h2 className="text-3xl font-bold text-gray-800 mb-2">Recycling Guidelines</h2>
                        <p className="text-gray-600">Match items to the correct <strong>recycling bin color</strong>:</p>
                    </div>

                    <div className="grid gap-6">
                        {recyclingInfo.map((item, index) => (
                            <div key={index} className="bg-white rounded-xl shadow-md overflow-hidden flex flex-col md:flex-row">
                                <div className={`w-full md:w-32 ${item.colorClass} p-4 flex items-center justify-center`}>
                                    <span className="text-white font-bold text-lg md:text-xl text-center">{item.title}</span>
                                </div>
                                
                                <div className="p-6 flex-1">
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className={`w-3 h-3 rounded-full ${item.colorClass}`}></span>
                                        <h3 className="text-xl font-bold text-gray-800 flex items-center gap-2">
                                            {item.colorName} Bin
                                            <TrashIcon className="w-5 h-5 text-gray-500" />
                                        </h3>
                                    </div>
                                    
                                    <div className="mb-4">
                                        <h4 className="font-semibold text-gray-700 mb-1">Description:</h4>
                                        <p className="text-gray-600">{item.description}</p>
                                    </div>
                                    
                                    <div className="bg-gray-50 p-3 rounded-lg border border-gray-100">
                                        <h4 className="font-semibold text-gray-700 mb-1 flex items-center gap-2">
                                            üí° Tip:
                                        </h4>
                                        <p className="text-sm text-gray-600 italic">{item.tip}</p>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );

        const FeedbackPage = ({
            setMenuOpen, menuOpen, handleLogout, setCurrentPage, setProfileOpen,
            feedback, setFeedback, handleFeedbackSubmit, feedbackSubmitted
        }) => (
            <div className="min-h-screen bg-gray-50">
                <header className="bg-green-600 text-white p-4 shadow-lg">
                    <div className="flex items-center justify-between">
                        <button onClick={() => setMenuOpen(!menuOpen)} className="p-2 hover:bg-green-700 rounded-lg">
                            {menuOpen ? <X className="w-6 h-6" /> : <Menu className="w-6 h-6" />}
                        </button>
                        <h1 className="text-2xl font-bold">Feedback</h1>
                        <button 
                            onClick={() => setProfileOpen(true)}
                            className="p-2 hover:bg-green-700 rounded-full"
                        >
                            <UserCircle className="w-7 h-7" />
                        </button>
                    </div>
                </header>
                {menuOpen && (
                    <div className="bg-white shadow-lg border-b">
                         <button
                            onClick={() => { setCurrentPage('home'); setMenuOpen(false); }}
                            className="w-full px-6 py-4 flex items-center gap-3 hover:bg-gray-100 border-b"
                        >
                            <Home className="w-5 h-5 text-green-600" />
                            <span className="font-medium">Home</span>
                        </button>
                        <button
                            onClick={() => { setCurrentPage('information'); setMenuOpen(false); }}
                            className="w-full px-6 py-4 flex items-center gap-3 hover:bg-gray-100 border-b"
                        >
                            <Info className="w-5 h-5 text-green-600" />
                            <span className="font-medium">Information</span>
                        </button>
                        <button
                            onClick={() => { setCurrentPage('feedback'); setMenuOpen(false); }}
                            className="w-full px-6 py-4 flex items-center gap-3 hover:bg-gray-100 border-b"
                        >
                            <MessageSquare className="w-5 h-5 text-green-600" />
                            <span className="font-medium">Feedback</span>
                        </button>
                        <button
                            onClick={handleLogout}
                            className="w-full px-6 py-4 flex items-center gap-3 hover:bg-gray-100 text-red-600"
                        >
                            <LogOut className="w-5 h-5" />
                            <span className="font-medium">Logout</span>
                        </button>
                    </div>
                )}
                <div className="p-6 max-w-2xl mx-auto">
                    <div className="bg-white rounded-xl shadow-lg p-8">
                        <div className="flex items-center gap-3 mb-6">
                            <MessageSquare className="w-8 h-8 text-green-600" />
                            <h2 className="text-3xl font-bold text-gray-800">We Value Your Feedback</h2>
                        </div>
                        <p className="text-gray-600 mb-6">
                            Help us improve the Recycling Scanner! Share your thoughts, suggestions, or report any issues you've encountered.
                        </p>
                        <textarea
                            value={feedback}
                            onChange={(e) => setFeedback(e.target.value)}
                            placeholder="Tell us what you think..."
                            className="w-full h-48 p-4 border-2 border-gray-300 rounded-lg focus:border-green-500 focus:outline-none resize-none"
                        />
                        <button
                            onClick={handleFeedbackSubmit}
                            disabled={!feedback.trim()}
                            className="w-full mt-4 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition disabled:bg-gray-300 disabled:cursor-not-allowed"
                        >
                            Submit Feedback
                        </button>
                        {feedbackSubmitted && (
                            <div className="mt-4 p-4 bg-green-50 border-2 border-green-500 rounded-lg text-center">
                                <p className="text-green-700 font-semibold">‚úì Thank you for your feedback!</p>
                                <p className="text-green-600 text-sm">We appreciate your input.</p>
                            </div>
                        )}
                    </div>
                    <div className="mt-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl shadow-lg p-6 text-white">
                        <h3 className="text-xl font-bold mb-3">Quick Tips</h3>
                        <ul className="space-y-2 text-sm">
                            <li>‚Ä¢ Be specific about any issues you encounter</li>
                            <li>‚Ä¢ Share ideas for new features you'd like to see</li>
                            <li>‚Ä¢ Let us know if scanning accuracy can be improved</li>
                            <li>‚Ä¢ Report any incorrect recycling information</li>
                        </ul>
                    </div>
                </div>
            </div>
        );


        // --- ‰∏ªÂ∫îÁî®ÁªÑ‰ª∂ ---
        const RecyclingScanner = () => {
            const [currentPage, setCurrentPage] = useState('welcome');
            const [menuOpen, setMenuOpen] = useState(false);
            const [leaderboard, setLeaderboard] = useState([]); 
            const [scannedImage, setScannedImage] = useState(null);
            const [scanResult, setScanResult] = useState(null);
            const [feedback, setFeedback] = useState('');
            const [feedbackSubmitted, setFeedbackSubmitted] = useState(false);
            const uploadInputRef = useRef(null);
            const cameraInputRef = useRef(null);

            // --- Firebase Áä∂ÊÄÅ ---
            const [user, setUser] = useState(null); 
            const [userProfile, setUserProfile] = useState(null); 
            const [firebaseReady, setFirebaseReady] = useState(false); 
            const [isAuthLoading, setIsAuthLoading] = useState(true); 
            
            const [isAuthActionLoading, setIsAuthActionLoading] = useState(false); 
            
            const [criticalError, setCriticalError] = useState(null);
            
            const [profileOpen, setProfileOpen] = useState(false);
            
            const [authError, setAuthError] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [username, setUsername] = useState('');
            const [isLoginView, setIsLoginView] = useState(true);
            
            const [signupSuccess, setSignupSuccess] = useState(false);
            
            const leaderboardListener = useRef(null);
            
            const isSigningUp = useRef(false);
            
            const [scoreAdded, setScoreAdded] = useState(false);

            const [currentUserEntry, setCurrentUserEntry] = useState(null);

            // *** Êñ∞Â¢ûÔºöÊøÄÊ¥ªÁ†ÅÁõ∏ÂÖ≥Áä∂ÊÄÅ ***
            const [activationCode, setActivationCode] = useState('');
            const [activationStatus, setActivationStatus] = useState('');
            const [isActivating, setIsActivating] = useState(false);
            const [resendStatus, setResendStatus] = useState(''); // *** Êñ∞Â¢ûÔºöÈáçÂèëÁä∂ÊÄÅ ***

            // --- Firebase ÊïàÊûúÈí©Â≠ê ---

            // 1. ËΩÆËØ¢ (Polling) Â¢ûÂä†ÈîôËØØÊ£ÄÊü•
            useEffect(() => {
                const intervalId = setInterval(() => {
                    if (window.firebase) {
                        console.log("Firebase is ready.");
                        setFirebaseReady(true);
                        clearInterval(intervalId);
                        return;
                    }
                    if (window.firebaseError) {
                        console.error("Firebase critical error detected:", window.firebaseError);
                        setCriticalError(window.firebaseError); 
                        setFirebaseReady(false); 
                        setIsAuthLoading(false); 
                        clearInterval(intervalId); 
                        return;
                    }
                    console.log("Waiting for firebase...");
                }, 100); 

                const timeoutId = setTimeout(() => {
                    clearInterval(intervalId);
                    if (!window.firebase && !window.firebaseError) {
                        console.error("Firebase failed to load after 10 seconds (Timeout).");
                        setCriticalError("Firebase failed to load (Timeout). Check network or ad-blockers.");
                        setIsAuthLoading(false);
                    }
                }, 10000); 

                return () => {
                    clearInterval(intervalId);
                    clearTimeout(timeoutId);
                };
            }, []); 

            // 2. ÁõëÂê¨ËÆ§ËØÅÁä∂ÊÄÅ
            useEffect(() => {
                if (!firebaseReady) return; 

                const unsubscribe = window.firebase.onAuthStateChanged(window.firebase.auth, async (authUser) => {
                    
                    if (leaderboardListener.current) {
                        leaderboardListener.current(); 
                        leaderboardListener.current = null;
                    }
                    
                    try {
                        if (authUser) {
                            console.log("Auth listener: User is logged in.", authUser.uid);
                            setUser(authUser); // ËøôÈáå‰ºöËß¶ÂèëÈáçÊñ∞Ê∏≤ÊüìÔºåuser?.emailVerified ‰ºöÊõ¥Êñ∞
                            const userDocRef = window.firebase.doc(window.firebase.db, 'users', authUser.uid);
                            const userDocSnap = await window.firebase.getDoc(userDocRef);
                            
                            // *** Ëá™Âä®ÈáçÁΩÆÈÄªËæë ***
                            const todayStr = new Date().toDateString();
                            
                            if (userDocSnap.exists()) {
                                let data = userDocSnap.data();
                                
                                // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÈáçÁΩÆÊØèÊó•Ê¨°Êï∞
                                if (data.lastScanDate !== todayStr) {
                                    console.log("New day detected, resetting scan count.");
                                    await window.firebase.updateDoc(userDocRef, {
                                        dailyScanCount: 0,
                                        lastScanDate: todayStr
                                    });
                                    data.dailyScanCount = 0;
                                    data.lastScanDate = todayStr;
                                }
                                
                                setUserProfile(data);
                            } else {
                                console.warn("User doc not found! Creating one...");
                                const newProfile = {
                                    uid: authUser.uid,
                                    email: authUser.email,
                                    username: authUser.email.split('@')[0], 
                                    score: 0,
                                    items: 0,
                                    joinedAt: new Date(),
                                    dailyScanCount: 0,
                                    lastScanDate: todayStr,
                                    isPremium: false
                                };
                                await window.firebase.setDoc(userDocRef, newProfile);
                                setUserProfile(newProfile); 
                            }
                            
                            if (!isSigningUp.current) {
                                setCurrentPage('home'); 
                            }
                        } else {
                            console.log("Auth listener: User is not logged in.");
                            setUser(null);
                            setUserProfile(null);
                            setLeaderboard([]); 
                            setCurrentUserEntry(null); 
                        }
                    } catch (error) {
                        console.error("Error during auth state change processing:", error);
                        setUser(authUser); 
                        setUserProfile(null);
                        if(authUser && !isSigningUp.current) setCurrentPage('home'); 
                    } finally {
                        setIsAuthLoading(false); 
                    }
                });
                
                return () => {
                    unsubscribe();
                    if (leaderboardListener.current) {
                        leaderboardListener.current(); 
                    }
                };
            }, [firebaseReady]); 

            // 3. ÁõëÂê¨ÊéíË°åÊ¶úÊï∞ÊçÆ (Áã¨Á´ã Effect, ‰æùËµñ firebaseReady Âíå user)
            useEffect(() => {
                if (!firebaseReady) return;

                const usersCollectionRef = window.firebase.collection(window.firebase.db, "users");
                const q = window.firebase.query(usersCollectionRef);

                leaderboardListener.current = window.firebase.onSnapshot(q, (snapshot) => {
                    const usersData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    usersData.sort((a, b) => (b.score || 0) - (a.score || 0));

                    // Top 5
                    const formattedLeaderboard = usersData.slice(0, 5).map(u => ({
                        name: u.username ? u.username : (u.email ? u.email.split('@')[0] : '...'),
                        score: u.score || 0,
                        items: u.items || 0,
                        id: u.id
                    }));
                    setLeaderboard(formattedLeaderboard);

                    // ËÆ°ÁÆóÂΩìÂâçÁî®Êà∑ÊéíÂêç
                    if (user) {
                         const myIndex = usersData.findIndex(u => u.id === user.uid);
                         if (myIndex !== -1) {
                             const u = usersData[myIndex];
                             setCurrentUserEntry({
                                name: u.username ? u.username : (u.email ? u.email.split('@')[0] : '...'),
                                score: u.score || 0,
                                items: u.items || 0,
                                id: u.id,
                                rank: myIndex + 1
                             });
                         } else {
                             setCurrentUserEntry(null);
                         }
                    } else {
                        setCurrentUserEntry(null);
                    }
                }, (error) => {
                    console.error("Error listening to leaderboard:", error);
                });

                return () => {
                     if (leaderboardListener.current) {
                        
                     }
                };
            }, [firebaseReady, user]); 

            // --- ËÆ§ËØÅÂ§ÑÁêÜÂáΩÊï∞ ---
            const handleAuthAction = async (e) => {
                e.preventDefault();
                setAuthError(''); 
                setSignupSuccess(false); 
                
                if (!firebaseReady) {
                    setAuthError("Firebase is not ready. Please wait.");
                    return;
                }
                
                setIsAuthActionLoading(true);

                if (isLoginView) {
                    try {
                        console.log("Attempting login for:", email);
                        await window.firebase.signInWithEmailAndPassword(window.firebase.auth, email, password);
                        console.log("Login successful");
                    } catch (error) {
                        console.error("Login failed:", error.code);
                        setAuthError(getFriendlyErrorMessage(error));
                        setIsAuthActionLoading(false); 
                    }
                } else {
                    if (!username) {
                        setAuthError('Please enter a username');
                        setIsAuthActionLoading(false); 
                        return;
                    }
                    
                    isSigningUp.current = true;
                    const todayStr = new Date().toDateString();
                    
                    try {
                        console.log("Attempting sign up for:", email);
                        const userCredential = await window.firebase.createUserWithEmailAndPassword(window.firebase.auth, email, password);
                        const user = userCredential.user;
                        
                        // *** ÂèëÈÄÅÈ™åËØÅÈÇÆ‰ª∂ ***
                        console.log("Sending verification email...");
                        await window.firebase.sendEmailVerification(user);

                        console.log("Sign up successful, creating user doc...");
                        
                        await window.firebase.setDoc(window.firebase.doc(window.firebase.db, "users", user.uid), {
                            uid: user.uid,
                            email: user.email,
                            username: username, 
                            score: 0,
                            items: 0,
                            joinedAt: new Date(),
                            dailyScanCount: 0,
                            lastScanDate: todayStr,
                            isPremium: false
                        });
                        console.log("User doc created.");

                        await window.firebase.signOut(window.firebase.auth); 
                        console.log("User signed out, showing success message.");
                        setSignupSuccess(true);  
                        setIsLoginView(true);     
                        setEmail('');             
                        setPassword('');
                        setUsername('');
                        
                    } catch (error) {
                        console.error("Sign up failed:", error.code);
                        setAuthError(getFriendlyErrorMessage(error));
                    } finally {
                        setIsAuthActionLoading(false); 
                        isSigningUp.current = false; 
                    }
                }
            };
            
            const getFriendlyErrorMessage = (error) => {
                switch(error.code) {
                    case 'auth/invalid-email':
                        return 'Invalid email format';
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        return 'Incorrect email or password';
                    case 'auth/invalid-credential':
                         return 'Account not found or password incorrect. Please sign up if you don\'t have an account.';
                    case 'auth/email-already-in-use':
                        return 'This email is already in use';
                    case 'auth/weak-password':
                        return 'Password is too weak (at least 6 characters)';
                    case 'auth/network-request-failed':
                        return 'Network error, please check your connection';
                    case 'auth/configuration-not-found':
                         return 'Firebase configuration not found. Please refresh.';
                    default:
                        return error.message; 
                }
            };
            
            const handleLogout = async () => {
                console.log("Logging out...");
                setMenuOpen(false);
                setProfileOpen(false); 
                if (!firebaseReady) return;
                
                await window.firebase.signOut(window.firebase.auth);
                
                setEmail('');
                setPassword('');
                setUsername('');
                setAuthError('');
                setIsLoginView(true);
                setSignupSuccess(false); 
                setActivationCode('');
                setActivationStatus('');
                setResendStatus(''); // Ê∏ÖÈô§ÈáçÂèëÁä∂ÊÄÅ
                setCurrentPage('login'); 
            };

            // *** Êñ∞Â¢ûÔºöÈáçÂèëÈ™åËØÅÈÇÆ‰ª∂ ***
            const handleResendVerification = async () => {
                if (!user) return;
                setResendStatus('Sending...');
                try {
                    await window.firebase.sendEmailVerification(user);
                    setResendStatus('Email sent! Please check your inbox.');
                } catch (error) {
                    console.error("Error sending verification email:", error);
                    setResendStatus('Error sending email. Try again later.');
                }
            };

            // *** ÊøÄÊ¥ªÈ´òÁ∫ß‰ºöÂëòÈÄªËæë ***
            const handleActivatePremium = async () => {
                if (!activationCode.trim()) return;
                if (!user || !firebaseReady) return;

                setIsActivating(true);
                setActivationStatus('');

                try {
                    const codesRef = window.firebase.collection(window.firebase.db, 'activation_codes');
                    const q = window.firebase.query(
                        codesRef, 
                        window.firebase.where('code', '==', activationCode.trim()),
                        window.firebase.where('isUsed', '==', false)
                    );

                    const querySnapshot = await window.firebase.getDocs(q);

                    if (querySnapshot.empty) {
                        setActivationStatus('Invalid or used code.');
                        setIsActivating(false);
                        return;
                    }

                    const codeDoc = querySnapshot.docs[0];
                    
                    await window.firebase.updateDoc(codeDoc.ref, {
                        isUsed: true,
                        usedBy: user.uid,
                        usedAt: new Date()
                    });

                    const userDocRef = window.firebase.doc(window.firebase.db, 'users', user.uid);
                    await window.firebase.updateDoc(userDocRef, {
                        isPremium: true
                    });

                    setUserProfile(prev => ({ ...prev, isPremium: true }));
                    setActivationStatus('Success! You are now Premium.');
                    setActivationCode(''); 

                } catch (error) {
                    console.error("Activation error:", error);
                    setActivationStatus('Error activating code. Please try again.');
                } finally {
                    setIsActivating(false);
                }
            };


            // --- ÂõæÂÉèÂ§ÑÁêÜÂáΩÊï∞ ---
            
            const handleAddScore = async () => {
                const currentUser = window.firebase.auth.currentUser;
                if (!firebaseReady || !currentUser || scoreAdded) return;

                setScoreAdded(true);
                
                try {
                    const userDocRef = window.firebase.doc(window.firebase.db, "users", currentUser.uid); 
                    await window.firebase.updateDoc(userDocRef, {
                        score: window.firebase.increment(10), 
                        items: window.firebase.increment(1)
                    });
                    console.log("Score updated for:", currentUser.uid);
                } catch (updateError) {
                    console.error("Failed to update score:", updateError);
                    setScoreAdded(false); 
                }
            };
            
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (!userProfile?.isPremium && (userProfile?.dailyScanCount || 0) >= 5) {
                        alert("Daily scan limit (5) reached! Please come back tomorrow or upgrade to Premium.");
                        e.target.value = ''; 
                        return;
                    }

                    setScoreAdded(false);
                    
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        setScannedImage(reader.result);
                        setScanResult(null); 
                        analyzeImageWithGemini(reader.result);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const analyzeImageWithGemini = async (imageData) => {
                try {
                    if (GEMINI_API_KEY === 'YOUR_GEMINI_API_KEY_HERE' || !GEMINI_API_KEY) {
                        throw new Error('Please set your Gemini API Key in the code');
                    }
                    const base64Image = imageData.split(',')[1];
                    const requestBody = { 
                        contents: [{
                            parts: [
                                {
                                    text: `Analyze this image and identify the item. Determine if it is recyclable or not. 
                                    Respond ONLY in JSON format with this exact structure:
                                    {
                                        "type": "item name",
                                        "recyclable": true or false,
                                        "category": "Paper/Glass/Plastic/Metal/Contaminated/Mixed Materials/Other",
                                        "confidence": number between 1-100
                                    }
                                    Be specific about the item type and category.`
                                },
                                {
                                    inline_data: {
                                        mime_type: "image/jpeg",
                                        data: base64Image
                                    }
                                }
                            ]
                        }]
                    };
                    
                    const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} - ${JSON.stringify(errorData)}`);
                    }

                    const data = await response.json();
                    const resultText = data.candidates[0].content.parts[0].text;
                    const jsonMatch = resultText.match(/\{[\s\S]*\}/);

                    if (jsonMatch) {
                        const result = JSON.parse(jsonMatch[0]);
                        setScanResult(result);
                        
                        const currentUser = window.firebase.auth.currentUser;
                        if (currentUser && firebaseReady) {
                            try {
                                const userDocRef = window.firebase.doc(window.firebase.db, "users", currentUser.uid);
                                await window.firebase.updateDoc(userDocRef, {
                                    dailyScanCount: window.firebase.increment(1)
                                });
                                setUserProfile(prev => ({
                                    ...prev,
                                    dailyScanCount: (prev.dailyScanCount || 0) + 1
                                }));
                            } catch (err) {
                                console.error("Failed to update scan count", err);
                            }
                        }
                        
                    } else {
                        throw new Error('Invalid response format from Gemini');
                    }
                } catch (error) {
                    console.error('Error analyzing image:', error);
                    // Fallback
                    setTimeout(async () => {
                        const results = [
                            { type: 'Plastic Bottle', recyclable: true, category: 'Plastic (#1)', confidence: 94 },
                            { type: 'Aluminum Can', recyclable: true, category: 'Metal', confidence: 98 },
                            { type: 'Pizza Box', recyclable: false, category: 'Contaminated Paper', confidence: 87 },
                            { type: 'Glass Jar', recyclable: true, category: 'Glass', confidence: 96 }
                        ];
                        const mockResult = results[Math.floor(Math.random() * results.length)];
                        setScanResult(mockResult);
                        alert(`API Error: ${error.message}\n\nUsing demo data. Please check Console (F12) for details.`);
                        
                         const currentUser = window.firebase.auth.currentUser;
                        if (currentUser && firebaseReady) {
                            const userDocRef = window.firebase.doc(window.firebase.db, "users", currentUser.uid);
                            try {
                                await window.firebase.updateDoc(userDocRef, {
                                    dailyScanCount: window.firebase.increment(1)
                                });
                                setUserProfile(prev => ({
                                    ...prev,
                                    dailyScanCount: (prev.dailyScanCount || 0) + 1
                                }));
                            } catch (err) {
                                console.error("Demo update failed", err)
                            }
                        }
                    }, 1000);
                }
            };
            
            const handleFeedbackSubmit = () => {
                if (feedback.trim()) {
                    setFeedbackSubmitted(true);
                    setTimeout(() => {
                        setFeedback('');
                        setFeedbackSubmitted(false);
                    }, 3000);
                }
            };

            if (criticalError) {
                return <CriticalErrorPage message={criticalError} />;
            }
            
            if (isAuthLoading) { 
                return <LoadingPage />;
            }
            
            return (
                <>
                    {currentPage === 'welcome' && <WelcomePage setCurrentPage={setCurrentPage} />}
                    
                    {currentPage === 'login' && 
                        <LoginPage 
                            handleAuthAction={handleAuthAction}
                            email={email}
                            setEmail={setEmail}
                            password={password}
                            setPassword={setPassword}
                            username={username}
                            setUsername={setUsername}
                            isLoginView={isLoginView}
                            setIsLoginView={setIsLoginView}
                            authError={authError}
                            signupSuccess={signupSuccess} 
                            isAuthActionLoading={isAuthActionLoading} 
                        />}
                    
                    {currentPage === 'home' && user && 
                        <HomePage 
                            setMenuOpen={setMenuOpen}
                            menuOpen={menuOpen}
                            handleLogout={handleLogout}
                            setCurrentPage={setCurrentPage}
                            setProfileOpen={setProfileOpen}
                            leaderboard={leaderboard}
                            uploadInputRef={uploadInputRef}
                            cameraInputRef={cameraInputRef}
                            handleImageUpload={handleImageUpload}
                            scannedImage={scannedImage}
                            scanResult={scanResult}
                            handleAddScore={handleAddScore}
                            scoreAdded={scoreAdded}
                            userProfile={userProfile} 
                            user={user} 
                            currentUserEntry={currentUserEntry} 
                        />}
                    
                    {currentPage === 'information' && user && 
                        <InformationPage 
                            setMenuOpen={setMenuOpen}
                            menuOpen={menuOpen}
                            handleLogout={handleLogout}
                            setCurrentPage={setCurrentPage}
                            setProfileOpen={setProfileOpen}
                            recyclingInfo={recyclingInfo}
                        />}
                    
                    {currentPage === 'feedback' && user && 
                        <FeedbackPage 
                            setMenuOpen={setMenuOpen}
                            menuOpen={menuOpen}
                            handleLogout={handleLogout}
                            setCurrentPage={setCurrentPage}
                            setProfileOpen={setProfileOpen}
                            feedback={feedback}
                            setFeedback={setFeedback}
                            handleFeedbackSubmit={handleFeedbackSubmit}
                            feedbackSubmitted={feedbackSubmitted}
                        />}
                    
                    {profileOpen && user && (
                        <ProfileModal 
                            user={user}
                            userProfile={userProfile}
                            handleLogout={handleLogout}
                            setProfileOpen={setProfileOpen}
                            // *** Êñ∞Â¢û Props ***
                            activationCode={activationCode}
                            setActivationCode={setActivationCode}
                            handleActivatePremium={handleActivatePremium}
                            activationStatus={activationStatus}
                            isActivating={isActivating}
                            handleResendVerification={handleResendVerification} // *** ‰º†ÈÄí ***
                            resendStatus={resendStatus} // *** ‰º†ÈÄí ***
                        />
                    )}
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RecyclingScanner />);
    </script>
</body>
</html>
